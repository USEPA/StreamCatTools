---
title: "StreamCatTools Demo"
author: "Marc Weber"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    highlighted: default 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
---

## Install StreamCatTools
Also make sure you have nhdplusTools installed - I am leveraging some functions from that package to complement grabbing Streamcat data.  I'm also using mapview package.
```{r load libraries, eval=TRUE, warning=FALSE, message=FALSE}
# requires devtools to install
# install.packages('devtools')
library(devtools)

# install from repository
# install_github('USEPA/StreamCatTools')
library(StreamCatTools)
library(sf)
library(nhdplusTools)
library(mapview)
library(dplyr)
library(knitr)
library(readr)
library(purrr)
library(tidyr)
library(ggplot2)
sessionInfo()
```

## Example One
Access several variables for several areas of interest and a couple COMIDs.  Loads into a tibble we can view.
```{r Example One, warning=FALSE, error=FALSE, message=FALSE}
df <- get_streamcat_data(metric='PctUrbMd2006,DamDens,TRIDens', aoi='riparian_catchment,catchment,watershed', comid='179,1337,1337420')
kable(df)
```

## Example Two
Access a couple watershed-only variables for a county (Benton County in this case). 
```{r Example Two, warning=FALSE, error=FALSE, message=FALSE}
df <- get_streamcat_data(metric='PctWdWet2006', aoi='watershed', county='41003')
kable(head(df))
```

## Example Three
Access a single variable for the Calapooia River. Use nhdplusTools library to grab flowlines and watershed for Calapooia, plot selected StreamCat metric for Calapooia and show watershed.
```{r Example Three, warning=FALSE, error=FALSE, message=FALSE, fig.width=9}
discover_nldi_sources()$source
start_comid = 23763529
nldi_feature <- list(featureSource = "comid", featureID = start_comid)
discover_nldi_navigation(nldi_feature)

flowline_nldi <- navigate_nldi(nldi_feature, mode = "upstreamTributaries", data_source = "")

# get StreamCat metrics
temp_dir <- 'C:/Users/mweber/temp'
nhdplus <- subset_nhdplus(comids = flowline_nldi$nhdplus_comid, output_file = file.path(temp_dir, "nhdplus.gpkg"),nhdplus_data = "download",overwrite = TRUE, return_data = FALSE)

st_layers(nhdplus)
cats <- read_sf(dsn=nhdplus, layer='CatchmentSP')
comids <- paste(cats$featureid,collapse=",",sep="")

df <- get_streamcat_data(metric='PctImp2011', aoi='catchment', comid=comids)

flowline_nldi$PCTIMP2011CAT <- df$PCTIMP2011CAT[match(flowline_nldi$nhdplus_comid, df$COMID)]

basin <- get_nldi_basin(nldi_feature = nldi_feature)

mapview(basin, alpha.regions=.08) + mapview(flowline_nldi, zcol = "PCTIMP2011CAT", legend = TRUE)
```

## Example Four
Grab NRSA data from NARS website directly in R, pull particular StreamCat metrics for sites, compare landscape metrics with other NRSA metrics
```{r Example Four, warning=FALSE, error=FALSE, message=FALSE}
nrsa <- read_csv('https://www.epa.gov/sites/production/files/2015-09/siteinfo_0.csv')
glimpse(nrsa)

# Gromote data frame to sf spatial points data frame
nrsa_sf <- st_as_sf(nrsa, coords = c("LON_DD83", "LAT_DD83"), crs = 4269)

# Get COMIDs using nhdplusTools package
# nrsa$COMID<- NA
# for (i in 1:nrow(nrsa_sf)){
#   print (i)
#   nrsa_sf[i,'COMID'] <- discover_nhdplus_id(nrsa_sf[i,c('geometry')])
# }
load("L:/Public/mweber/example.RData")

# get particular StreamCat data for all these NRSA sites
# nrsa_sf$COMID <- as.character(nrsa_sf$COMID)
comids <- nrsa_sf$COMID
comids <- comids[!is.na(comids)]
comids <- comids[c(1:925)]
comids <- paste(comids,collapse=',')
df1 <- get_streamcat_data(metric='PctCrop2006', aoi='watershed', comid=comids)

comids2 <- nrsa_sf$COMID
comids2 <- comids2[!is.na(comids2)]
comids2 <- comids2[c(926:1856)]
comids2 <- paste(comids2,collapse=',')
df2 <- get_streamcat_data(metric='PctCrop2006', aoi='watershed', comid=comids2)

comids3 <- nrsa_sf$COMID
comids3 <- comids3[!is.na(comids2)]
comids3 <- comids3[c(1856:2320)]
comids3 <- paste(comids3,collapse=',')
df3 <- get_streamcat_data(metric='PctCrop2006', aoi='watershed', comid=comids3)

df <- rbind(df1, df2, df3)
glimpse(df)
df$COMID <- as.integer(df$COMID)
nrsa_sf <- left_join(nrsa_sf, df, by='COMID')
```

```{r Example Four ggplot, warning=FALSE, error=FALSE, message=FALSE, fig.width=9}
# download mmi from NARS web page
mmi <- read_csv('https://www.epa.gov/sites/production/files/2015-09/bentcond.csv')
glimpse(mmi)

# join mmi to NARS info data frame with StreamCat PctCrop metric
nrsa_sf <- left_join(nrsa_sf, mmi[,c('SITE_ID','BENT_MMI_COND')], by='SITE_ID')
nrsa_sf %>% 
  drop_na(BENT_MMI_COND) %>%
  ggplot(aes(x=PCTCROP2006WS, y=BENT_MMI_COND))+
  geom_boxplot()

```